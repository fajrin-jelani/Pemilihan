<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Voting</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    * {
      font-family: 'Poppins', sans-serif;
    }
    .vote-card {
      transition: all 0.3s ease;
    }
    .vote-card:hover {
      transform: translateY(-4px);
    }
    .progress-bar {
      transition: width 0.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.4s ease-out forwards;
    }
    .toast {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-800 overflow-auto">
  <div id="app" class="w-full min-h-full p-6 md:p-8"><!-- Header -->
   <header class="text-center mb-8 fade-in relative">
    <div class="absolute top-0 right-0 md:right-4 flex gap-2"><button onclick="showResultsPasswordModal()" class="px-4 py-2 bg-white/20 hover:bg-white/30 backdrop-blur text-white font-semibold rounded-xl transition-all shadow-lg border border-white/30 inline-flex items-center gap-2 text-sm md:text-base"> <span class="text-xl">ğŸ“Š</span> <span class="hidden sm:inline">Lihat Hasil</span> </button> <button onclick="showSettingsPasswordModal()" class="px-4 py-2 bg-white/20 hover:bg-white/30 backdrop-blur text-white font-semibold rounded-xl transition-all shadow-lg border border-white/30 inline-flex items-center gap-2 text-sm md:text-base"> <span class="text-xl">âš™ï¸</span> <span class="hidden sm:inline">Pengaturan</span> </button>
    </div>
    <div class="inline-flex items-center gap-3 mb-4"><span class="text-4xl">ï¿½ï¿½ï¿½ï¿½ï¿½ï¸</span>
     <h1 id="main-title" class="text-3xl md:text-4xl font-extrabold text-white drop-shadow-lg">Pemilihan Ketua</h1>
    </div>
    <p class="text-purple-200 text-lg">Pilih calon favoritmu!</p>
   </header><!-- Voter Registration Card -->
   <div id="voter-registration-card" class="max-w-md mx-auto mb-8 bg-white/95 backdrop-blur-md rounded-2xl p-6 border border-white/30 shadow-xl">
    <div class="text-center mb-4"><span class="text-5xl mb-3 block">ğŸ‘‹</span>
     <h2 class="text-2xl font-bold text-gray-800 mb-2">Selamat Datang!</h2>
     <p class="text-gray-600">Masukkan nama Anda untuk mulai voting</p>
    </div>
    <form id="registration-form" onsubmit="handleRegistration(event)"><label for="registration-name-input" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label> <input type="text" id="registration-name-input" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors mb-4" placeholder="Masukkan nama Anda" required maxlength="50"> <button type="submit" class="w-full px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-xl font-semibold transition-all shadow-lg"> ğŸ—³ï¸ Mulai Voting </button>
    </form>
   </div><!-- Voting Cards -->
   <div id="voting-section" class="max-w-6xl mx-auto mb-10 hidden">
    <div class="bg-white/20 backdrop-blur-md rounded-xl p-4 mb-6 border border-white/30">
     <div class="flex justify-between items-center">
      <p class="text-white font-semibold">Voting sebagai: <span id="current-voter-name" class="text-yellow-300"></span></p><button onclick="handleLogout()" class="px-4 py-2 bg-red-500/80 hover:bg-red-600 text-white rounded-lg font-medium transition-all text-sm"> ğŸšª Keluar </button>
     </div>
    </div>
    <div id="voting-info"></div>
    <div id="candidates-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"><!-- Candidate cards will be rendered here -->
    </div>
   </div><!-- Results Section -->
   <div id="results-section" class="max-w-4xl mx-auto bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20 fade-in hidden" style="animation-delay: 0.2s">
    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2"><span>ğŸ“Š</span> Hasil Voting Real-time</h2>
    <div id="results-container" class="space-y-4"><!-- Results will be rendered here -->
    </div>
    <div class="mt-6 pt-4 border-t border-white/20 flex justify-between items-center">
     <p class="text-purple-200">Total suara: <span id="total-votes" class="font-bold text-white">0</span></p><button id="reset-btn" onclick="showConfirmModal()" class="px-4 py-2 bg-red-500/80 hover:bg-red-600 text-white rounded-lg font-medium transition-all text-sm hidden"> ğŸ”„ Reset Voting </button>
    </div>
   </div><!-- Toast Container -->
   <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div><!-- Settings Password Modal -->
   <div id="settings-password-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden items-center justify-center">
    <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 w-full">
     <div class="text-center mb-4"><span class="text-4xl mb-2 block">ï¿½ï¿½</span>
      <h3 class="text-xl font-bold text-gray-800">Password Pengaturan</h3>
      <p class="text-gray-600 text-sm mt-1">Masukkan password untuk mengakses pengaturan</p>
     </div>
     <form id="settings-password-form" onsubmit="handleSettingsPasswordSubmit(event)"><label for="settings-password-input" class="block text-sm font-medium text-gray-700 mb-2">Password</label> <input type="password" id="settings-password-input" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors" placeholder="Masukkan password" required>
      <div class="flex gap-3 mt-6"><button type="button" onclick="hideSettingsPasswordModal()" class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-all"> Batal </button> <button type="submit" class="flex-1 px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium transition-all"> Masuk </button>
      </div>
     </form>
    </div>
   </div><!-- Results Password Modal -->
   <div id="results-password-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden items-center justify-center">
    <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 w-full">
     <div class="text-center mb-4"><span class="text-4xl mb-2 block">ğŸ”</span>
      <h3 class="text-xl font-bold text-gray-800">Password Hasil Voting</h3>
      <p class="text-gray-600 text-sm mt-1">Masukkan password untuk melihat hasil dan data pemilih</p>
     </div>
     <form id="results-password-form" onsubmit="handleResultsPasswordSubmit(event)"><label for="results-password-input" class="block text-sm font-medium text-gray-700 mb-2">Password</label> <input type="password" id="results-password-input" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors" placeholder="Masukkan password" required>
      <div class="flex gap-3 mt-6"><button type="button" onclick="hideResultsPasswordModal()" class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-all"> Batal </button> <button type="submit" class="flex-1 px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium transition-all"> Lihat Hasil </button>
      </div>
     </form>
    </div>
   </div><!-- Confirm Reset Modal -->
   <div id="confirm-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden items-center justify-center">
    <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 text-center"><span class="text-5xl mb-4 block">âš ï¸</span>
     <h3 class="text-xl font-bold text-gray-800 mb-2">Reset Voting?</h3>
     <p class="text-gray-600 mb-6">Semua suara akan dihapus. Tindakan ini tidak dapat dibatalkan.</p>
     <div class="flex gap-3 justify-center"><button id="cancel-reset" onclick="hideConfirmModal()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-all"> Batal </button> <button id="confirm-reset" onclick="handleReset()" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-all"> Ya, Reset </button>
     </div>
    </div>
   </div><!-- Settings Modal -->
   <div id="settings-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center overflow-y-auto p-4">
    <div class="bg-white rounded-2xl p-6 max-w-2xl w-full my-8 max-h-[90vh] overflow-y-auto">
     <div class="text-center mb-6"><span class="text-5xl mb-3 block">âš™ï¸</span>
      <h3 class="text-2xl font-bold text-gray-800">Pengaturan Voting</h3>
      <p class="text-gray-600 text-sm mt-1">Kelola judul dan kandidat voting Anda</p>
     </div><!-- Edit Title Section -->
     <div class="mb-6 pb-6 border-b border-gray-200">
      <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2"><span>ğŸ“</span> Judul Voting</h4>
      <form id="title-form" onsubmit="handleTitleUpdate(event)"><label for="title-input" class="block text-sm font-medium text-gray-700 mb-2">Judul</label> <input type="text" id="title-input" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors mb-3" placeholder="Masukkan judul voting" required maxlength="100"> <button type="submit" class="w-full px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium transition-all"> ï¿½ï¿½ï¿½ï¿½ï¿½ Simpan Judul </button>
      </form>
     </div><!-- Password Settings Section -->
     <div class="mb-6 pb-6 border-b border-gray-200">
      <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2"><span>ï¿½ï¿½ï¿½</span> Pengaturan Password</h4>
      <div class="space-y-4">
       <div><label for="settings-password-new" class="block text-sm font-medium text-gray-700 mb-2">Password Pengaturan</label> <input type="password" id="settings-password-new" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors" placeholder="Masukkan password baru"> <button onclick="handleUpdateSettingsPassword()" class="mt-2 w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-all text-sm"> ğŸ’¾ Ubah Password Pengaturan </button>
       </div>
       <div><label for="results-password-new" class="block text-sm font-medium text-gray-700 mb-2">Password Hasil Voting</label> <input type="password" id="results-password-new" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors" placeholder="Masukkan password baru"> <button onclick="handleUpdateResultsPassword()" class="mt-2 w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-all text-sm"> ğŸ’¾ Ubah Password Hasil </button>
       </div>
      </div>
     </div><!-- Voting Mode Section -->
     <div class="mb-6 pb-6 border-b border-gray-200">
      <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2"><span>ğŸ”¢</span> Mode Voting</h4>
      <div class="bg-gray-50 rounded-lg p-4 border border-gray-200"><label class="flex items-center justify-between cursor-pointer mb-4">
        <div>
         <p class="font-medium text-gray-800">Izinkan Memilih Banyak Kandidat</p>
         <p class="text-sm text-gray-600 mt-1">Satu pemilih dapat memilih lebih dari satu kandidat</p>
        </div>
        <div class="relative"><input type="checkbox" id="multiple-votes-toggle" class="sr-only peer" onchange="handleVotingModeToggle(this.checked)">
         <div class="w-14 h-8 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:start-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-purple-600"></div>
        </div></label>
       <div id="max-choices-section" class="mt-4 pt-4 border-t border-gray-300 hidden"><label for="max-choices-select" class="block text-sm font-medium text-gray-700 mb-2">Maksimum Pilihan per Pemilih</label> <select id="max-choices-select" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors" onchange="handleMaxChoicesChange(this.value)"> <option value="2">2 kandidat</option> <option value="3">3 kandidat</option> <option value="4">4 kandidat</option> <option value="5">5 kandidat</option> <option value="6">6 kandidat</option> <option value="7">7 kandidat</option> <option value="8">8 kandidat</option> <option value="9">9 kandidat</option> <option value="10">10 kandidat</option> <option value="11">11 kandidat</option> <option value="12">12 kandidat</option> <option value="13">13 kandidat</option> <option value="14">14 kandidat</option> <option value="15">15 kandidat</option> <option value="16">16 kandidat</option> <option value="17">17 kandidat</option> <option value="18">18 kandidat</option> <option value="19">19 kandidat</option> <option value="20">20 kandidat</option> </select>
        <p class="text-xs text-gray-500 mt-2">Pemilih dapat memilih hingga jumlah kandidat yang ditentukan</p>
       </div>
      </div>
     </div><!-- Manage Candidates Section -->
     <div class="mb-6">
      <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2"><span>ğŸ‘¥</span> Kelola Kandidat</h4>
      <div id="settings-candidates-list" class="space-y-3 mb-4"><!-- Candidates will be rendered here -->
      </div><button onclick="showAddCandidateModal()" class="w-full px-4 py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-medium transition-all flex items-center justify-center gap-2"> <span class="text-xl">â•</span> Tambah Kandidat Baru </button>
     </div><!-- Close Button --> <button onclick="hideSettingsModal()" class="w-full px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-all"> Tutup </button>
    </div>
   </div><!-- Edit Candidate Modal -->
   <div id="edit-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 w-full">
     <div class="text-center mb-4"><span class="text-4xl mb-2 block">âœï¸</span>
      <h3 class="text-xl font-bold text-gray-800">Edit Nama Kandidat</h3>
     </div>
     <form id="edit-form" onsubmit="handleEditSubmit(event)"><label for="edit-name-input" class="block text-sm font-medium text-gray-700 mb-2">Nama Kandidat</label> <input type="text" id="edit-name-input" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors" placeholder="Masukkan nama kandidat" required maxlength="50">
      <div class="flex gap-3 mt-6"><button type="button" onclick="hideEditModal()" class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-all"> Batal </button> <button type="submit" class="flex-1 px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium transition-all"> Simpan </button>
      </div>
     </form>
    </div>
   </div><!-- Add Candidate Modal -->
   <div id="add-candidate-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 w-full">
     <div class="text-center mb-4"><span class="text-4xl mb-2 block">â•</span>
      <h3 class="text-xl font-bold text-gray-800">Tambah Kandidat Baru</h3>
     </div>
     <form id="add-candidate-form" onsubmit="handleAddCandidate(event)"><label for="new-candidate-name" class="block text-sm font-medium text-gray-700 mb-2">Nama Kandidat</label> <input type="text" id="new-candidate-name" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors" placeholder="Masukkan nama kandidat baru" required maxlength="50">
      <div class="flex gap-3 mt-6"><button type="button" onclick="hideAddCandidateModal()" class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-all"> Batal </button> <button type="submit" class="flex-1 px-6 py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-medium transition-all"> Tambah </button>
      </div>
     </form>
    </div>
   </div>
  </div>
  <script>
    // Default configuration
    const defaultConfig = {
      voting_title: 'Pemilihan Ketua',
      candidate_1: 'M.FACHRUL',
      candidate_2: 'andri tobing',
      candidate_3: 'LA HARDIN',
      candidate_4: 'YOGA PRADANA',
      candidate_5: 'HAMI',
      candidate_6: 'M. PUTRA',
      candidate_7: 'Muhibbillah',
      candidate_8: 'M. SAFARUDIN',
      candidate_9: 'WAHYU R',
      candidate_10: 'REGA APDILLAH',
      candidate_11: 'M. HUSAIRI RIFAI',
      candidate_12: 'KASMURI',
      candidate_13: 'Adhit prastya',
      candidate_14: 'AKBAR',
      candidate_15: 'SYULFACKAR',
      candidate_16: 'Syahrul fitri',
      candidate_17: 'm. arya putra',
      candidate_18: 'DION',
      candidate_19: 'sulaiman',
      candidate_20: 'TRY SANDY',
      candidate_21: 'mychel jp',
      allow_multiple_votes: false,
      max_choices: 2,
      background_color: '#4c1d95',
      card_color: '#ffffff',
      text_color: '#1f2937',
      primary_action_color: '#8b5cf6',
      secondary_action_color: '#ec4899'
    };

    // Candidate data with emojis and colors
    const candidateStyles = [
      { emoji: 'ğŸ‘¤', gradient: 'from-blue-500 to-cyan-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-emerald-500 to-teal-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-orange-500 to-amber-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-pink-500 to-rose-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-violet-500 to-purple-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-red-500 to-pink-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-yellow-500 to-orange-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-teal-500 to-cyan-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-indigo-500 to-blue-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-lime-500 to-green-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-fuchsia-500 to-pink-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-sky-500 to-blue-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-green-500 to-emerald-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-amber-500 to-yellow-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-rose-500 to-red-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-purple-500 to-violet-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-cyan-500 to-teal-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-blue-600 to-indigo-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-emerald-600 to-green-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-orange-600 to-red-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-pink-600 to-fuchsia-400' }
    ];

    // State
    let votes = [];
    let config = { ...defaultConfig };
    let isResetting = false;
    let currentEditingCandidateId = null;
    let currentVotingCandidateId = null;
    let candidates = [];
    let hasVoted = false;
    let deviceId = '';
    let passwordRecords = [];
    let configRecords = [];
    let isResultsVisible = false;
    let currentVoterName = '';
    let isRegistered = false;

    // Generate or retrieve device ID
    function getDeviceId() {
      let id = localStorage.getItem('voting_device_id');
      if (!id) {
        id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('voting_device_id', id);
      }
      return id;
    }

    // Handle registration
    function handleRegistration(event) {
      event.preventDefault();
      const input = document.getElementById('registration-name-input');
      const name = input.value.trim();
      
      if (!name) {
        showToast('Nama tidak boleh kosong!', 'warning');
        return;
      }

      currentVoterName = name;
      isRegistered = true;
      localStorage.setItem('current_voter_name', name);
      
      showVotingSection();
      showToast(`Selamat datang, ${name}!`);
    }

    // Show voting section
    function showVotingSection() {
      const registrationCard = document.getElementById('voter-registration-card');
      const votingSection = document.getElementById('voting-section');
      const currentVoterNameEl = document.getElementById('current-voter-name');
      
      registrationCard.classList.add('hidden');
      votingSection.classList.remove('hidden');
      currentVoterNameEl.textContent = currentVoterName;
    }

    // Handle logout
    function handleLogout() {
      currentVoterName = '';
      isRegistered = false;
      localStorage.removeItem('current_voter_name');
      
      const registrationCard = document.getElementById('voter-registration-card');
      const votingSection = document.getElementById('voting-section');
      const registrationInput = document.getElementById('registration-name-input');
      
      votingSection.classList.add('hidden');
      registrationCard.classList.remove('hidden');
      registrationInput.value = '';
      
      showToast('Anda telah keluar dari sesi voting');
    }

    // Check saved registration
    function checkSavedRegistration() {
      const savedName = localStorage.getItem('current_voter_name');
      if (savedName) {
        currentVoterName = savedName;
        isRegistered = true;
        showVotingSection();
      }
    }

    // Check if device has voted
    function checkIfVoted() {
      deviceId = getDeviceId();
      const allowMultiple = config.allow_multiple_votes !== undefined ? config.allow_multiple_votes : defaultConfig.allow_multiple_votes;
      
      if (!allowMultiple) {
        hasVoted = votes.some(vote => vote.voter_name === deviceId || vote.voter_name.startsWith(deviceId + '|'));
      } else {
        hasVoted = false;
      }
    }

    // Get votes by current device
    function getDeviceVotes() {
      return votes.filter(vote => vote.voter_name === deviceId || vote.voter_name.startsWith(deviceId + '|'));
    }

    // Check if device has voted for specific candidate
    function hasVotedForCandidate(candidateId) {
      const deviceVotes = getDeviceVotes();
      return deviceVotes.some(vote => vote.candidate_id === candidateId);
    }

    // Get remaining choices for device
    function getRemainingChoices() {
      const allowMultiple = config.allow_multiple_votes !== undefined ? config.allow_multiple_votes : defaultConfig.allow_multiple_votes;
      if (!allowMultiple) return hasVoted ? 0 : 1;
      
      const maxChoices = config.max_choices !== undefined ? config.max_choices : defaultConfig.max_choices;
      const deviceVotes = getDeviceVotes();
      return maxChoices - deviceVotes.length;
    }

    // Load candidates from config
    function loadCandidates() {
      candidates = [];
      let i = 1;
      while (true) {
        const key = `candidate_${i}`;
        const name = config[key] !== undefined && config[key] !== '' ? config[key] : (i === 1 ? defaultConfig[key] : null);
        if (name && name !== '') {
          candidates.push({
            id: String(i),
            name: name
          });
          i++;
        } else if (i === 1) {
          if (defaultConfig[key]) {
            candidates.push({
              id: String(i),
              name: defaultConfig[key]
            });
          }
          i++;
        } else {
          const nextKey = `candidate_${i + 1}`;
          if (config[nextKey] && config[nextKey] !== '') {
            i++;
            continue;
          }
          break;
        }
      }
    }

    // Load config from database
    function loadConfigFromDatabase() {
      if (configRecords.length === 0) return;
      
      const dbConfig = {};
      configRecords.forEach(record => {
        if (record.config_key && record.config_value !== undefined) {
          // Parse boolean and number values
          let value = record.config_value;
          if (value === 'true') value = true;
          else if (value === 'false') value = false;
          else if (!isNaN(value) && value !== '') value = parseFloat(value);
          
          dbConfig[record.config_key] = value;
        }
      });
      
      // Merge with current config
      config = { ...defaultConfig, ...dbConfig };
      
      // Update UI
      loadCandidates();
      renderCandidates();
      renderResults();
      updateTitle();
    }

    // Save config to database
    async function saveConfigToDatabase(key, value) {
      const existingRecord = configRecords.find(r => r.config_key === key);
      
      // Convert value to string for storage
      const stringValue = String(value);
      
      if (existingRecord) {
        const updatedRecord = { ...existingRecord, config_value: stringValue };
        const result = await window.dataSdk.update(updatedRecord);
        return result.isOk;
      } else {
        if (votes.length + passwordRecords.length + configRecords.length >= 999) {
          showToast('Batas maksimum data tercapai!', 'warning');
          return false;
        }
        const result = await window.dataSdk.create({
          config_key: key,
          config_value: stringValue,
          voted_at: new Date().toISOString()
        });
        return result.isOk;
      }
    }

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          
          // Update candidate_1 field in edit panel if it was changed
          if (newConfig.candidate_1 !== undefined) {
            const candidate1Input = document.getElementById('title-input');
            if (candidate1Input && candidate1Input.getAttribute('data-field') === 'candidate_1') {
              candidate1Input.value = newConfig.candidate_1;
            }
          }
          
          loadCandidates();
          renderCandidates();
          renderResults();
          updateTitle();
          
          // Refresh settings candidates list if modal is open
          const settingsModal = document.getElementById('settings-modal');
          if (settingsModal && !settingsModal.classList.contains('hidden')) {
            renderSettingsCandidatesList();
          }
        },
        mapToCapabilities: (cfg) => ({
          recolorables: [
            {
              get: () => window.elementSdk.config.background_color || defaultConfig.background_color,
              set: (v) => { window.elementSdk.config.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
            },
            {
              get: () => window.elementSdk.config.card_color || defaultConfig.card_color,
              set: (v) => { window.elementSdk.config.card_color = v; window.elementSdk.setConfig({ card_color: v }); }
            },
            {
              get: () => window.elementSdk.config.text_color || defaultConfig.text_color,
              set: (v) => { window.elementSdk.config.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
            },
            {
              get: () => window.elementSdk.config.primary_action_color || defaultConfig.primary_action_color,
              set: (v) => { window.elementSdk.config.primary_action_color = v; window.elementSdk.setConfig({ primary_action_color: v }); }
            },
            {
              get: () => window.elementSdk.config.secondary_action_color || defaultConfig.secondary_action_color,
              set: (v) => { window.elementSdk.config.secondary_action_color = v; window.elementSdk.setConfig({ secondary_action_color: v }); }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['voting_title', cfg.voting_title || defaultConfig.voting_title],
          ['candidate_1', cfg.candidate_1 || defaultConfig.candidate_1]
        ])
      });
      
      config = { ...defaultConfig, ...window.elementSdk.config };
    }

    // Data handler for Data SDK
    const dataHandler = {
      onDataChanged(data) {
        if (!data || data.length === 0) {
          votes = [];
          passwordRecords = [];
          configRecords = [];
        } else {
          votes = data.filter(record => record.candidate_id && !record.settings_password && !record.results_password && !record.config_key);
          passwordRecords = data.filter(record => record.settings_password || record.results_password);
          configRecords = data.filter(record => record.config_key);
          
          // Load config from database
          loadConfigFromDatabase();
        }
        
        checkIfVoted();
        if (isResultsVisible) {
          renderResults();
        }
        renderCandidates();
        updateResetButton();
      }
    };

    // Initialize Data SDK
    window.dataSdk.init(dataHandler);

    // Get stored password
    function getStoredPassword(type) {
      const passwordRecord = passwordRecords.find(r => r[type]);
      return passwordRecord ? passwordRecord[type] : null;
    }

    // Verify password
    function verifyPassword(inputPassword, type) {
      const storedPassword = getStoredPassword(type);
      if (!storedPassword) return true;
      return inputPassword === storedPassword;
    }

    // Show settings password modal
    function showSettingsPasswordModal() {
      const modal = document.getElementById('settings-password-modal');
      const input = document.getElementById('settings-password-input');
      input.value = '';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      setTimeout(() => input.focus(), 100);
    }

    // Hide settings password modal
    function hideSettingsPasswordModal() {
      const modal = document.getElementById('settings-password-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // Handle settings password submit
    function handleSettingsPasswordSubmit(event) {
      event.preventDefault();
      const input = document.getElementById('settings-password-input');
      const password = input.value;

      if (verifyPassword(password, 'settings_password')) {
        hideSettingsPasswordModal();
        showSettingsModal();
      } else {
        showToast('Password salah!', 'error');
        input.value = '';
        input.focus();
      }
    }

    // Show results password modal
    function showResultsPasswordModal() {
      const modal = document.getElementById('results-password-modal');
      const input = document.getElementById('results-password-input');
      input.value = '';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      setTimeout(() => input.focus(), 100);
    }

    // Hide results password modal
    function hideResultsPasswordModal() {
      const modal = document.getElementById('results-password-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // Handle results password submit
    function handleResultsPasswordSubmit(event) {
      event.preventDefault();
      const input = document.getElementById('results-password-input');
      const password = input.value;

      if (verifyPassword(password, 'results_password')) {
        hideResultsPasswordModal();
        showResults();
      } else {
        showToast('Password salah!', 'error');
        input.value = '';
        input.focus();
      }
    }

    // Show results section
    function showResults() {
      isResultsVisible = true;
      const section = document.getElementById('results-section');
      section.classList.remove('hidden');
      renderResults();
      section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      showToast('Hasil voting berhasil ditampilkan!');
    }

    // Update settings password
    async function handleUpdateSettingsPassword() {
      const input = document.getElementById('settings-password-new');
      const newPassword = input.value.trim();

      if (!newPassword) {
        showToast('Password tidak boleh kosong!', 'warning');
        return;
      }

      if (newPassword.length < 4) {
        showToast('Password minimal 4 karakter!', 'warning');
        return;
      }

      const existingRecord = passwordRecords.find(r => r.settings_password);
      
      if (existingRecord) {
        const updatedRecord = { ...existingRecord, settings_password: newPassword };
        const result = await window.dataSdk.update(updatedRecord);
        if (result.isOk) {
          showToast('Password pengaturan berhasil diubah!');
          input.value = '';
        } else {
          showToast('Gagal mengubah password!', 'error');
        }
      } else {
        if (votes.length + passwordRecords.length >= 999) {
          showToast('Batas maksimum data tercapai!', 'warning');
          return;
        }
        const result = await window.dataSdk.create({
          settings_password: newPassword,
          voted_at: new Date().toISOString()
        });
        if (result.isOk) {
          showToast('Password pengaturan berhasil dibuat!');
          input.value = '';
        } else {
          showToast('Gagal membuat password!', 'error');
        }
      }
    }

    // Update results password
    async function handleUpdateResultsPassword() {
      const input = document.getElementById('results-password-new');
      const newPassword = input.value.trim();

      if (!newPassword) {
        showToast('Password tidak boleh kosong!', 'warning');
        return;
      }

      if (newPassword.length < 4) {
        showToast('Password minimal 4 karakter!', 'warning');
        return;
      }

      const existingRecord = passwordRecords.find(r => r.results_password);
      
      if (existingRecord) {
        const updatedRecord = { ...existingRecord, results_password: newPassword };
        const result = await window.dataSdk.update(updatedRecord);
        if (result.isOk) {
          showToast('Password hasil voting berhasil diubah!');
          input.value = '';
        } else {
          showToast('Gagal mengubah password!', 'error');
        }
      } else {
        if (votes.length + passwordRecords.length >= 999) {
          showToast('Batas maksimum data tercapai!', 'warning');
          return;
        }
        const result = await window.dataSdk.create({
          results_password: newPassword,
          voted_at: new Date().toISOString()
        });
        if (result.isOk) {
          showToast('Password hasil voting berhasil dibuat!');
          input.value = '';
        } else {
          showToast('Gagal membuat password!', 'error');
        }
      }
    }

    // Get candidate name by ID
    function getCandidateName(id) {
      const key = `candidate_${id}`;
      return config[key] || defaultConfig[key] || 'Unknown';
    }

    // Count votes for each candidate
    function countVotes() {
      const counts = {};
      candidates.forEach(c => {
        counts[c.id] = 0;
      });
      votes.forEach(vote => {
        if (counts.hasOwnProperty(vote.candidate_id)) {
          counts[vote.candidate_id]++;
        }
      });
      return counts;
    }

    // Update title
    function updateTitle() {
      const titleEl = document.getElementById('main-title');
      if (titleEl) {
        titleEl.textContent = config.voting_title || defaultConfig.voting_title;
      }
    }

    // Show toast notification
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 ${
        type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-red-500' : 'bg-amber-500'
      } text-white font-medium`;
      toast.innerHTML = `
        <span>${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'âš ï¸'}</span>
        <span>${message}</span>
      `;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Render candidate cards
    function renderCandidates() {
      const grid = document.getElementById('candidates-grid');
      const remainingChoices = getRemainingChoices();
      const allowMultiple = config.allow_multiple_votes !== undefined ? config.allow_multiple_votes : defaultConfig.allow_multiple_votes;

      grid.innerHTML = candidates.map((candidate, index) => {
        const style = candidateStyles[index % candidateStyles.length];
        const hasVotedThis = hasVotedForCandidate(candidate.id);
        const canVote = remainingChoices > 0 && !hasVotedThis;
        
        return `
          <div class="vote-card bg-white/95 backdrop-blur rounded-2xl overflow-hidden shadow-xl border border-white/50 fade-in" style="animation-delay: ${index * 0.1}s">
            <div class="bg-gradient-to-r ${style.gradient} p-6 text-center">
              <div class="w-20 h-20 mx-auto bg-white/30 rounded-full flex items-center justify-center text-4xl mb-3 shadow-inner">
                ${style.emoji}
              </div>
              <span class="text-white/80 text-sm font-medium">Calon ${candidate.id}</span>
            </div>
            <div class="p-5 text-center">
              <h3 class="text-xl font-bold text-gray-800 mb-4 truncate" title="${candidate.name}">${candidate.name}</h3>
              ${hasVotedThis ? `
                <button 
                  class="w-full py-3 bg-emerald-500 text-white font-semibold rounded-xl shadow-md cursor-default"
                  disabled
                  title="Anda sudah memilih kandidat ini"
                >
                  âœ… Sudah Dipilih
                </button>
              ` : canVote ? `
                <button 
                  onclick="handleVote('${candidate.id}')"
                  class="w-full py-3 bg-gradient-to-r ${style.gradient} text-white font-semibold rounded-xl hover:opacity-90 transition-all shadow-md hover:shadow-lg"
                >
                  ğŸ—³ï¸ Vote
                </button>
              ` : `
                <button 
                  class="w-full py-3 bg-gray-400 cursor-not-allowed text-white font-semibold rounded-xl shadow-md"
                  disabled
                  title="${allowMultiple ? 'Batas pilihan tercapai' : 'Anda sudah melakukan voting'}"
                >
                  ${allowMultiple ? 'ğŸ”’ Batas Tercapai' : 'ï¿½ï¿½ï¿½ Sudah Vote'}
                </button>
              `}
            </div>
          </div>
        `;
      }).join('');
      
      // Show remaining choices info if multiple voting is enabled
      if (allowMultiple) {
        const infoDiv = document.getElementById('voting-info');
        if (infoDiv) {
          infoDiv.innerHTML = `
            <div class="text-center mb-6 bg-white/20 backdrop-blur-md rounded-xl p-4 border border-white/30">
              <p class="text-white font-semibold">
                ${remainingChoices > 0 
                  ? `Anda dapat memilih ${remainingChoices} kandidat lagi` 
                  : 'Anda sudah mencapai batas pilihan maksimum'}
              </p>
            </div>
          `;
        }
      }
    }

    // Render results
    function renderResults() {
      const container = document.getElementById('results-container');
      const totalVotesEl = document.getElementById('total-votes');
      const voteCounts = countVotes();
      const totalVotes = votes.length;

      totalVotesEl.textContent = totalVotes;

      const sortedCandidates = [...candidates].sort((a, b) => voteCounts[b.id] - voteCounts[a.id]);

      container.innerHTML = sortedCandidates.map((candidate, index) => {
        const count = voteCounts[candidate.id] || 0;
        const percentage = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
        const style = candidateStyles[parseInt(candidate.id) - 1] || candidateStyles[0];
        const isLeading = index === 0 && count > 0;
        
        const votersForCandidate = votes.filter(v => v.candidate_id === candidate.id);
        const votersList = votersForCandidate.map(v => {
          const parts = v.voter_name.split('|');
          return parts.length > 1 ? parts[1] : v.voter_name;
        }).join(', ');

        return `
          <div class="bg-white/10 rounded-xl p-4 ${isLeading ? 'ring-2 ring-yellow-400' : ''}">
            <div class="flex justify-between items-center mb-2">
              <div class="flex items-center gap-2">
                ${isLeading ? '<span class="text-yellow-400">ğŸ‘‘</span>' : ''}
                <span class="font-semibold text-white truncate max-w-[150px] sm:max-w-none">${candidate.name}</span>
              </div>
              <span class="text-purple-200 font-medium">${count} suara (${percentage}%)</span>
            </div>
            <div class="h-3 bg-white/20 rounded-full overflow-hidden mb-2">
              <div 
                class="progress-bar h-full bg-gradient-to-r ${style.gradient} rounded-full"
                style="width: ${percentage}%"
              ></div>
            </div>
            ${votersForCandidate.length > 0 ? `
              <div class="text-xs text-purple-200 mt-2">
                <span class="font-medium">Pemilih:</span> ${votersList}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // Update reset button visibility
    function updateResetButton() {
      const resetBtn = document.getElementById('reset-btn');
      if (votes.length > 0) {
        resetBtn.classList.remove('hidden');
      } else {
        resetBtn.classList.add('hidden');
      }
    }

    // Handle vote
    async function handleVote(candidateId) {
      if (!isRegistered || !currentVoterName) {
        showToast('Silakan masukkan nama terlebih dahulu!', 'warning');
        return;
      }

      const allowMultiple = config.allow_multiple_votes !== undefined ? config.allow_multiple_votes : defaultConfig.allow_multiple_votes;
      const remainingChoices = getRemainingChoices();
      
      if (hasVotedForCandidate(candidateId)) {
        showToast('Anda sudah memilih kandidat ini!', 'warning');
        return;
      }

      if (remainingChoices <= 0) {
        if (allowMultiple) {
          const maxChoices = config.max_choices !== undefined ? config.max_choices : defaultConfig.max_choices;
          showToast(`Anda sudah mencapai batas maksimum ${maxChoices} pilihan!`, 'warning');
        } else {
          showToast('Anda sudah melakukan voting dari perangkat ini!', 'warning');
        }
        return;
      }

      if (votes.length + passwordRecords.length + configRecords.length >= 999) {
        showToast('Batas maksimum 999 suara telah tercapai!', 'warning');
        return;
      }

      // Disable button and show loading
      const buttonEl = event.target;
      const originalHTML = buttonEl.innerHTML;
      buttonEl.disabled = true;
      buttonEl.innerHTML = 'â³ Memproses...';

      const voterData = deviceId + '|' + currentVoterName;

      const result = await window.dataSdk.create({
        candidate_id: candidateId,
        voter_name: voterData,
        voted_at: new Date().toISOString()
      });

      if (result.isOk) {
        hasVoted = true;
        showToast(`Suara untuk ${getCandidateName(candidateId)} berhasil dicatat!`);
      } else {
        showToast('Gagal mencatat suara. Silakan coba lagi.', 'error');
        buttonEl.disabled = false;
        buttonEl.innerHTML = originalHTML;
      }
    }

    // Submit vote
    async function submitVote() {
      if (!currentVotingCandidateId || !currentVoterName) return;

      const voterData = deviceId + '|' + currentVoterName;

      const result = await window.dataSdk.create({
        candidate_id: currentVotingCandidateId,
        voter_name: voterData,
        voted_at: new Date().toISOString()
      });

      if (result.isOk) {
        hasVoted = true;
        showToast(`Suara untuk ${getCandidateName(currentVotingCandidateId)} berhasil dicatat!`);
      } else {
        showToast('Gagal mencatat suara. Silakan coba lagi.', 'error');
      }

      currentVotingCandidateId = null;
    }

    // Show confirm modal
    function showConfirmModal() {
      const modal = document.getElementById('confirm-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    // Hide confirm modal
    function hideConfirmModal() {
      const modal = document.getElementById('confirm-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // Show settings modal
    function showSettingsModal() {
      const modal = document.getElementById('settings-modal');
      const titleInput = document.getElementById('title-input');
      const multipleVotesToggle = document.getElementById('multiple-votes-toggle');
      const maxChoicesSelect = document.getElementById('max-choices-select');
      const maxChoicesSection = document.getElementById('max-choices-section');
      
      titleInput.value = config.voting_title || defaultConfig.voting_title;
      const allowMultiple = config.allow_multiple_votes !== undefined ? config.allow_multiple_votes : defaultConfig.allow_multiple_votes;
      multipleVotesToggle.checked = allowMultiple;
      
      const maxChoices = config.max_choices !== undefined ? config.max_choices : defaultConfig.max_choices;
      maxChoicesSelect.value = maxChoices;
      
      if (allowMultiple) {
        maxChoicesSection.classList.remove('hidden');
      } else {
        maxChoicesSection.classList.add('hidden');
      }
      
      renderSettingsCandidatesList();
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    // Handle voting mode toggle
    function handleVotingModeToggle(isChecked) {
      const maxChoicesSection = document.getElementById('max-choices-section');
      
      if (isChecked) {
        maxChoicesSection.classList.remove('hidden');
      } else {
        maxChoicesSection.classList.add('hidden');
      }
      
      config.allow_multiple_votes = isChecked;
      saveConfigToDatabase('allow_multiple_votes', isChecked);
      showToast(isChecked ? 'Mode pilihan banyak diaktifkan!' : 'Mode pilihan tunggal diaktifkan!');
    }

    // Handle max choices change
    function handleMaxChoicesChange(value) {
      const maxChoices = parseInt(value);
      config.max_choices = maxChoices;
      saveConfigToDatabase('max_choices', maxChoices);
      showToast(`Maksimum pilihan diubah menjadi ${maxChoices} kandidat`);
    }

    // Hide settings modal
    function hideSettingsModal() {
      const modal = document.getElementById('settings-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // Render candidates list in settings modal
    function renderSettingsCandidatesList() {
      const container = document.getElementById('settings-candidates-list');
      
      container.innerHTML = candidates.map((candidate, index) => {
        const votesForCandidate = votes.filter(v => v.candidate_id === candidate.id).length;
        const canDelete = votesForCandidate === 0;
        
        return `
          <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-sm font-medium text-gray-500">Calon ${candidate.id}</span>
                ${votesForCandidate > 0 ? `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${votesForCandidate} suara</span>` : ''}
              </div>
              <p class="font-semibold text-gray-800">${candidate.name}</p>
            </div>
            <button 
              onclick="showEditModalFromSettings('${candidate.id}')"
              class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-all text-sm"
              title="Edit nama kandidat"
            >
              âœï¸
            </button>
            <button 
              onclick="handleDeleteCandidateFromSettings('${candidate.id}')"
              class="px-3 py-2 ${canDelete ? 'bg-red-500 hover:bg-red-600' : 'bg-gray-400 cursor-not-allowed'} text-white rounded-lg font-medium transition-all text-sm"
              ${!canDelete ? 'disabled' : ''}
              title="${canDelete ? 'Hapus kandidat' : `Tidak dapat dihapus (${votesForCandidate} suara)`}"
            >
              ğŸ—‘ï¸
            </button>
          </div>
        `;
      }).join('');
    }

    // Handle title update
    function handleTitleUpdate(event) {
      event.preventDefault();
      
      const input = document.getElementById('title-input');
      const newTitle = input.value.trim();
      
      if (!newTitle) {
        showToast('Judul tidak boleh kosong!', 'warning');
        return;
      }

      config.voting_title = newTitle;
      saveConfigToDatabase('voting_title', newTitle);
      updateTitle();
      showToast('Judul berhasil diubah!');
    }

    // Show edit modal from settings
    function showEditModalFromSettings(candidateId) {
      showEditModal(candidateId);
    }

    // Show edit modal
    function showEditModal(candidateId) {
      currentEditingCandidateId = candidateId;
      const currentName = getCandidateName(candidateId);
      const input = document.getElementById('edit-name-input');
      input.value = currentName;
      
      const modal = document.getElementById('edit-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      setTimeout(() => input.focus(), 100);
    }

    // Hide edit modal
    function hideEditModal() {
      const modal = document.getElementById('edit-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      currentEditingCandidateId = null;
      
      const settingsModal = document.getElementById('settings-modal');
      if (!settingsModal.classList.contains('hidden')) {
        renderSettingsCandidatesList();
      }
    }

    // Handle edit submit
    function handleEditSubmit(event) {
      event.preventDefault();
      
      if (!currentEditingCandidateId) return;
      
      const input = document.getElementById('edit-name-input');
      const newName = input.value.trim();
      
      if (!newName) {
        showToast('Nama tidak boleh kosong!', 'warning');
        return;
      }

      const configKey = `candidate_${currentEditingCandidateId}`;
      config[configKey] = newName;
      saveConfigToDatabase(configKey, newName);
      
      loadCandidates();
      renderCandidates();
      renderResults();
      
      showToast(`Nama kandidat berhasil diubah!`);
      hideEditModal();
    }

    // Show add candidate modal
    function showAddCandidateModal() {
      const input = document.getElementById('new-candidate-name');
      input.value = '';
      
      const modal = document.getElementById('add-candidate-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      setTimeout(() => input.focus(), 100);
    }

    // Hide add candidate modal
    function hideAddCandidateModal() {
      const modal = document.getElementById('add-candidate-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      
      const settingsModal = document.getElementById('settings-modal');
      if (!settingsModal.classList.contains('hidden')) {
        renderSettingsCandidatesList();
      }
    }

    // Handle add candidate
    function handleAddCandidate(event) {
      event.preventDefault();
      
      const input = document.getElementById('new-candidate-name');
      const newName = input.value.trim();
      
      if (!newName) {
        showToast('Nama tidak boleh kosong!', 'warning');
        return;
      }

      let nextId = candidates.length + 1;
      const configKey = `candidate_${nextId}`;
      config[configKey] = newName;
      saveConfigToDatabase(configKey, newName);
      
      loadCandidates();
      renderCandidates();
      
      showToast(`Kandidat baru "${newName}" berhasil ditambahkan!`);
      hideAddCandidateModal();
    }

    // Handle delete candidate from settings
    function handleDeleteCandidateFromSettings(candidateId) {
      const candidateName = getCandidateName(candidateId);
      const votesForCandidate = votes.filter(v => v.candidate_id === candidateId).length;
      
      if (votesForCandidate > 0) {
        showToast(`Tidak dapat menghapus ${candidateName} karena sudah memiliki ${votesForCandidate} suara`, 'warning');
        return;
      }

      const configKey = `candidate_${candidateId}`;
      config[configKey] = '';
      saveConfigToDatabase(configKey, '');
      
      loadCandidates();
      renderCandidates();
      
      showToast(`Kandidat "${candidateName}" berhasil dihapus!`);
      
      setTimeout(() => renderSettingsCandidatesList(), 300);
    }

    // Handle reset
    async function handleReset() {
      if (isResetting || votes.length === 0) return;
      
      isResetting = true;
      hideConfirmModal();
      
      const resetBtn = document.getElementById('reset-btn');
      resetBtn.disabled = true;
      resetBtn.innerHTML = 'ï¿½ï¿½ï¿½ Mereset...';

      for (const vote of [...votes]) {
        await window.dataSdk.delete(vote);
      }

      localStorage.removeItem('voting_device_id');
      localStorage.removeItem('current_voter_name');
      hasVoted = false;
      deviceId = getDeviceId();
      currentVoterName = '';
      isRegistered = false;
      
      // Reset to registration card
      const registrationCard = document.getElementById('voter-registration-card');
      const votingSection = document.getElementById('voting-section');
      const registrationInput = document.getElementById('registration-name-input');
      
      votingSection.classList.add('hidden');
      registrationCard.classList.remove('hidden');
      registrationInput.value = '';

      showToast('Voting telah direset!');
      isResetting = false;
      resetBtn.disabled = false;
      resetBtn.innerHTML = 'ğŸ”„ Reset Voting';
    }

    // Initial render
    deviceId = getDeviceId();
    loadCandidates();
    checkSavedRegistration();
    renderCandidates();
    renderResults();
    updateTitle();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c84aa00f19a6d3b',t:'MTc3MDE1MDM5NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
